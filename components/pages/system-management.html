<!-- 系统管理页面 -->
<div id="system-managementPage" class="page">
    <div class="page-header">
        <h1>系统管理</h1>
    </div>

    <div class="page-content">
        <!-- 标签页导航 -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchSystemTab('users')">用户管理</button>
            <button class="tab-btn" onclick="switchSystemTab('roles')">角色权限</button>
            <button class="tab-btn" onclick="switchSystemTab('logs')">操作日志</button>
        </div>

        <!-- 用户管理标签页 -->
        <div id="system-users" class="tab-content active">
            <div class="tab-header" style="display: flex; align-items: center; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-primary" onclick="showUserForm()">
                    <span class="btn-icon">+</span>
                    新增用户
                </button>
            </div>
            
            <style>
                #system-managementPage .data-table th,
                #system-managementPage .data-table td {
                    text-align: left !important;
                }
            </style>
            <div class="table-container">
                <table class="data-table" style="table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 12%;">  <!-- 用户名 -->
                        <col style="width: 20%;">  <!-- 邮箱 -->
                        <col style="width: 12%;">  <!-- 角色 -->
                        <col style="width: 12%;">  <!-- 部门 -->
                        <col style="width: 18%;">  <!-- 最后登录时间 -->
                        <col style="width: 26%;">  <!-- 操作 -->
                    </colgroup>
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>角色</th>
                            <th>部门</th>
                            <th>最后登录时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="system-users-empty"><td colspan="6" style="text-align:center; color:#999; padding: 16px;">暂无用户</td></tr>
                    </tbody>
                </table>
                
                <!-- 用户分页 -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="users-pagination-info">第 1 / 1 页，共 1 条</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="users-prev-btn" onclick="changeSystemUsersPage(-1)">上一页</button>
                        <div class="pagination-pages" id="users-pagination-pages"></div>
                        <button class="pagination-btn" id="users-next-btn" onclick="changeSystemUsersPage(1)">下一页</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色权限标签页 -->
        <div id="system-roles" class="tab-content">
            <div class="tab-header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <h3>角色权限</h3>
                <button class="btn btn-primary" onclick="showRoleForm()">
                    <span class="btn-icon">+</span>
                    新增角色
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>角色名称</th>
                            <th>角色代码</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="system-roles-tbody">
                        <tr id="system-roles-empty"><td colspan="4" style="text-align:center; color:#999; padding: 16px;">暂无角色</td></tr>
                    </tbody>
                </table>
                
                <!-- 角色分页 -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="roles-pagination-info">第 1 / 1 页，共 1 条</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="roles-prev-btn" onclick="changeSystemRolesPage(-1)">上一页</button>
                        <div class="pagination-pages" id="roles-pagination-pages"></div>
                        <button class="pagination-btn" id="roles-next-btn" onclick="changeSystemRolesPage(1)">下一页</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- 操作日志标签页 -->
        <div id="system-logs" class="tab-content">
            <div class="tab-header">
                <h3>操作日志</h3>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>用户</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="system-logs-tbody">
                        <tr id="system-logs-empty"><td colspan="3" style="text-align:center; color:#999; padding: 16px;">暂无日志</td></tr>
                    </tbody>
                </table>
                
                <!-- 日志分页 -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="logs-pagination-info">第 1 / 1 页，共 1 条</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="logs-prev-btn" onclick="changeSystemLogsPage(-1)">上一页</button>
                        <div class="pagination-pages" id="logs-pagination-pages"></div>
                        <button class="pagination-btn" id="logs-next-btn" onclick="changeSystemLogsPage(1)">下一页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 角色编辑模态框 -->
<div id="roleModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="roleModalTitle">新增角色</h3>
            <span class="close" id="btn-role-modal-x" onclick="closeRoleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="roleForm">
                <div class="form-group">
                    <label for="roleName">角色名称 <span style="color: red;">*</span></label>
                    <input type="text" id="roleName" name="roleName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="roleCode">角色代码 <span style="color: red;">*</span></label>
                    <input type="text" id="roleCode" name="roleCode" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="roleDescription">角色描述</label>
                    <textarea id="roleDescription" name="roleDescription" class="form-input" rows="3"></textarea>
                </div>
                
                <!-- 权限配置区域 -->
                <div class="form-group">
                    <label>导航权限配置</label>
                    <div class="permissions-container" style="border: 1px solid #ddd; border-radius: 8px; padding: 16px; background: #f9f9f9;">
                        <div id="permissionsGrid" class="permissions-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- 工时管理权限已移除，后端强制为true -->
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-project-management" name="permissions" value="project-management">
                                <span>📋 项目管理</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-staff-management" name="permissions" value="staff-management">
                                <span>👤 员工列表</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-approval-center" name="permissions" value="approval-center">
                                <span>✓ 审核中心</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-report-management" name="permissions" value="report-management">
                                <span>📊 报表管理</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-project-dashboard" name="permissions" value="project-dashboard">
                                <span>📈 项目看板</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-ai-assistant" name="permissions" value="ai-assistant">
                                <span>? 智能问数</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-knowledge-base" name="permissions" value="knowledge-base">
                                <span>📚 知识库</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-team-management" name="permissions" value="team-management">
                                <span>👥 团队管理</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-budget-management" name="permissions" value="budget-management">
                                <span>$ 预算管理</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-system-management" name="permissions" value="system-management">
                                <span>⚙ 系统管理</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btn-role-cancel" onclick="closeRoleModal()">取消</button>
            <button class="btn btn-primary" id="btn-role-save" onclick="saveRole()">保存</button>
        </div>
    </div>
</div>

<script>
// 系统管理相关函数
// showUserForm 函数已移至 main.js 中

function editUser(userId) {
    console.log('编辑用户:', userId);
    showNotification(`编辑用户 ${userId}`, 'info');
}

function deleteUser(userId) {
    if (confirm(`确定要删除用户 ${userId} 吗？`)) {
        console.log('删除用户:', userId);
        showNotification(`用户 ${userId} 已删除`, 'success');
    }
}

// showRoleForm, editRole, deleteRole 函数已移至 main.js 中

// 日志分页（演示用：仅UI与状态）
let logsCurrentPage = 1;
let logsTotalPages = 1;

function initLogsPagination(current, total, totalCount) {
    logsCurrentPage = current;
    logsTotalPages = Math.max(1, total);
    const info = document.getElementById('logs-pagination-info');
    const pagesEl = document.getElementById('logs-pagination-pages');
    const prevBtn = document.getElementById('logs-prev-btn');
    const nextBtn = document.getElementById('logs-next-btn');
    if (info) info.textContent = `第 ${logsCurrentPage} / ${logsTotalPages} 页，共 ${totalCount} 条`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= logsTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === logsCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoLogsPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = logsCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = logsCurrentPage >= logsTotalPages;
}

function changeLogsPage(direction) {
    const target = logsCurrentPage + direction;
    gotoLogsPage(target);
}

function gotoLogsPage(page) {
    if (page < 1 || page > logsTotalPages) return;
    logsCurrentPage = page;
    // 这里可接入后端分页API获取数据
    initLogsPagination(logsCurrentPage, logsTotalPages, 1);
}

// 用户分页（演示用：仅UI与状态）
let usersCurrentPage = 1;
let usersTotalPages = 1;

function initUsersPagination(current, total, totalCount) {
    usersCurrentPage = current;
    usersTotalPages = Math.max(1, total);
    const info = document.getElementById('users-pagination-info');
    const pagesEl = document.getElementById('users-pagination-pages');
    const prevBtn = document.getElementById('users-prev-btn');
    const nextBtn = document.getElementById('users-next-btn');
    if (info) info.textContent = `第 ${usersCurrentPage} / ${usersTotalPages} 页，共 ${totalCount} 条`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= usersTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === usersCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoUsersPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = usersCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = usersCurrentPage >= usersTotalPages;
}

function changeUsersPage(direction) {
    const target = usersCurrentPage + direction;
    gotoUsersPage(target);
}

function gotoUsersPage(page) {
    if (page < 1 || page > usersTotalPages) return;
    usersCurrentPage = page;
    // 这里可接入后端分页API获取用户数据
    initUsersPagination(usersCurrentPage, usersTotalPages, 1);
}

// 角色分页（演示用：仅UI与状态）
let rolesCurrentPage = 1;
let rolesTotalPages = 1;

function initRolesPagination(current, total, totalCount) {
    rolesCurrentPage = current;
    rolesTotalPages = Math.max(1, total);
    const info = document.getElementById('roles-pagination-info');
    const pagesEl = document.getElementById('roles-pagination-pages');
    const prevBtn = document.getElementById('roles-prev-btn');
    const nextBtn = document.getElementById('roles-next-btn');
    if (info) info.textContent = `第 ${rolesCurrentPage} / ${rolesTotalPages} 页，共 ${totalCount} 条`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= rolesTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === rolesCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoRolesPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = rolesCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = rolesCurrentPage >= rolesTotalPages;
}

function changeRolesPage(direction) {
    const target = rolesCurrentPage + direction;
    gotoRolesPage(target);
}

function gotoRolesPage(page) {
    if (page < 1 || page > rolesTotalPages) return;
    rolesCurrentPage = page;
    // 这里可接入后端分页API获取角色数据
    initRolesPagination(rolesCurrentPage, rolesTotalPages, 1);
}

// 页面加载时初始化
// 载入与渲染
// 这些函数已移至 main.js 中，避免函数名冲突

// 这些函数已移至 main.js 中，避免函数名冲突

function populateRoleOptions(selectId) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const roles = window.__rolesCache || [];
    sel.innerHTML = '<option value="">请选择角色</option>' + roles.map(r => `<option value="${r.id}">${r.role_name}</option>`).join('');
}

// submitNewUser 函数已移至 main.js 中

// 数据加载逻辑已移至 main.js 中的 initializeSystemManagementPage 函数

// 角色模态框事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 加载角色列表
    loadRolesList();
});

// 导出函数到全局作用域
window.showRoleForm = showRoleForm;
window.closeRoleModal = closeRoleModal;
window.saveRole = saveRole;
window.editRole = editRole;
window.deleteRole = deleteRole;
window.loadRolesList = loadRolesList;
window.renderRolesTable = renderRolesTable;
</script>
