<!-- ç³»ç»Ÿç®¡ç†é¡µé¢ -->
<div id="system-managementPage" class="page">
    <div class="page-header">
        <h1>ç³»ç»Ÿç®¡ç†</h1>
    </div>

    <div class="page-content">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchSystemTab('users')">ç”¨æˆ·ç®¡ç†</button>
            <button class="tab-btn" onclick="switchSystemTab('roles')">è§’è‰²æƒé™</button>
            <button class="tab-btn" onclick="switchSystemTab('logs')">æ“ä½œæ—¥å¿—</button>
        </div>

        <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="system-users" class="tab-content active">
            <div class="tab-header" style="display: flex; align-items: center; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-primary" onclick="showUserForm()">
                    <span class="btn-icon">+</span>
                    æ–°å¢ç”¨æˆ·
                </button>
            </div>
            
            <style>
                #system-managementPage .data-table th,
                #system-managementPage .data-table td {
                    text-align: left !important;
                }
            </style>
            <div class="table-container">
                <table class="data-table" style="table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 12%;">  <!-- ç”¨æˆ·å -->
                        <col style="width: 20%;">  <!-- é‚®ç®± -->
                        <col style="width: 12%;">  <!-- è§’è‰² -->
                        <col style="width: 12%;">  <!-- éƒ¨é—¨ -->
                        <col style="width: 18%;">  <!-- æœ€åç™»å½•æ—¶é—´ -->
                        <col style="width: 26%;">  <!-- æ“ä½œ -->
                    </colgroup>
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>éƒ¨é—¨</th>
                            <th>æœ€åç™»å½•æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="system-users-empty"><td colspan="6" style="text-align:center; color:#999; padding: 16px;">æš‚æ— ç”¨æˆ·</td></tr>
                    </tbody>
                </table>
                
                <!-- ç”¨æˆ·åˆ†é¡µ -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="users-pagination-info">ç¬¬ 1 / 1 é¡µï¼Œå…± 1 æ¡</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="users-prev-btn" onclick="changeSystemUsersPage(-1)">ä¸Šä¸€é¡µ</button>
                        <div class="pagination-pages" id="users-pagination-pages"></div>
                        <button class="pagination-btn" id="users-next-btn" onclick="changeSystemUsersPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§’è‰²æƒé™æ ‡ç­¾é¡µ -->
        <div id="system-roles" class="tab-content">
            <div class="tab-header" style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <h3>è§’è‰²æƒé™</h3>
                <button class="btn btn-primary" onclick="showRoleForm()">
                    <span class="btn-icon">+</span>
                    æ–°å¢è§’è‰²
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è§’è‰²åç§°</th>
                            <th>è§’è‰²ä»£ç </th>
                            <th>æè¿°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="system-roles-tbody">
                        <tr id="system-roles-empty"><td colspan="4" style="text-align:center; color:#999; padding: 16px;">æš‚æ— è§’è‰²</td></tr>
                    </tbody>
                </table>
                
                <!-- è§’è‰²åˆ†é¡µ -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="roles-pagination-info">ç¬¬ 1 / 1 é¡µï¼Œå…± 1 æ¡</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="roles-prev-btn" onclick="changeSystemRolesPage(-1)">ä¸Šä¸€é¡µ</button>
                        <div class="pagination-pages" id="roles-pagination-pages"></div>
                        <button class="pagination-btn" id="roles-next-btn" onclick="changeSystemRolesPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- æ“ä½œæ—¥å¿—æ ‡ç­¾é¡µ -->
        <div id="system-logs" class="tab-content">
            <div class="tab-header">
                <h3>æ“ä½œæ—¥å¿—</h3>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ç”¨æˆ·</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="system-logs-tbody">
                        <tr id="system-logs-empty"><td colspan="3" style="text-align:center; color:#999; padding: 16px;">æš‚æ— æ—¥å¿—</td></tr>
                    </tbody>
                </table>
                
                <!-- æ—¥å¿—åˆ†é¡µ -->
                <div class="pagination-container" style="margin-top: 12px;">
                    <div class="pagination-info">
                        <span id="logs-pagination-info">ç¬¬ 1 / 1 é¡µï¼Œå…± 1 æ¡</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="logs-prev-btn" onclick="changeSystemLogsPage(-1)">ä¸Šä¸€é¡µ</button>
                        <div class="pagination-pages" id="logs-pagination-pages"></div>
                        <button class="pagination-btn" id="logs-next-btn" onclick="changeSystemLogsPage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è§’è‰²ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="roleModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="roleModalTitle">æ–°å¢è§’è‰²</h3>
            <span class="close" id="btn-role-modal-x" onclick="closeRoleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="roleForm">
                <div class="form-group">
                    <label for="roleName">è§’è‰²åç§° <span style="color: red;">*</span></label>
                    <input type="text" id="roleName" name="roleName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="roleCode">è§’è‰²ä»£ç  <span style="color: red;">*</span></label>
                    <input type="text" id="roleCode" name="roleCode" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="roleDescription">è§’è‰²æè¿°</label>
                    <textarea id="roleDescription" name="roleDescription" class="form-input" rows="3"></textarea>
                </div>
                
                <!-- æƒé™é…ç½®åŒºåŸŸ -->
                <div class="form-group">
                    <label>å¯¼èˆªæƒé™é…ç½®</label>
                    <div class="permissions-container" style="border: 1px solid #ddd; border-radius: 8px; padding: 16px; background: #f9f9f9;">
                        <div id="permissionsGrid" class="permissions-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- å·¥æ—¶ç®¡ç†æƒé™å·²ç§»é™¤ï¼Œåç«¯å¼ºåˆ¶ä¸ºtrue -->
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-project-management" name="permissions" value="project-management">
                                <span>ğŸ“‹ é¡¹ç›®ç®¡ç†</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-staff-management" name="permissions" value="staff-management">
                                <span>ğŸ‘¤ å‘˜å·¥åˆ—è¡¨</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-approval-center" name="permissions" value="approval-center">
                                <span>âœ“ å®¡æ ¸ä¸­å¿ƒ</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-report-management" name="permissions" value="report-management">
                                <span>ğŸ“Š æŠ¥è¡¨ç®¡ç†</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-project-dashboard" name="permissions" value="project-dashboard">
                                <span>ğŸ“ˆ é¡¹ç›®çœ‹æ¿</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-ai-assistant" name="permissions" value="ai-assistant">
                                <span>? æ™ºèƒ½é—®æ•°</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-knowledge-base" name="permissions" value="knowledge-base">
                                <span>ğŸ“š çŸ¥è¯†åº“</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-team-management" name="permissions" value="team-management">
                                <span>ğŸ‘¥ å›¢é˜Ÿç®¡ç†</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-budget-management" name="permissions" value="budget-management">
                                <span>$ é¢„ç®—ç®¡ç†</span>
                            </label>
                            <label class="permission-item" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="perm-system-management" name="permissions" value="system-management">
                                <span>âš™ ç³»ç»Ÿç®¡ç†</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="btn-role-cancel" onclick="closeRoleModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="btn-role-save" onclick="saveRole()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
// ç³»ç»Ÿç®¡ç†ç›¸å…³å‡½æ•°
// showUserForm å‡½æ•°å·²ç§»è‡³ main.js ä¸­

function editUser(userId) {
    console.log('ç¼–è¾‘ç”¨æˆ·:', userId);
    showNotification(`ç¼–è¾‘ç”¨æˆ· ${userId}`, 'info');
}

function deleteUser(userId) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${userId} å—ï¼Ÿ`)) {
        console.log('åˆ é™¤ç”¨æˆ·:', userId);
        showNotification(`ç”¨æˆ· ${userId} å·²åˆ é™¤`, 'success');
    }
}

// showRoleForm, editRole, deleteRole å‡½æ•°å·²ç§»è‡³ main.js ä¸­

// æ—¥å¿—åˆ†é¡µï¼ˆæ¼”ç¤ºç”¨ï¼šä»…UIä¸çŠ¶æ€ï¼‰
let logsCurrentPage = 1;
let logsTotalPages = 1;

function initLogsPagination(current, total, totalCount) {
    logsCurrentPage = current;
    logsTotalPages = Math.max(1, total);
    const info = document.getElementById('logs-pagination-info');
    const pagesEl = document.getElementById('logs-pagination-pages');
    const prevBtn = document.getElementById('logs-prev-btn');
    const nextBtn = document.getElementById('logs-next-btn');
    if (info) info.textContent = `ç¬¬ ${logsCurrentPage} / ${logsTotalPages} é¡µï¼Œå…± ${totalCount} æ¡`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= logsTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === logsCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoLogsPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = logsCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = logsCurrentPage >= logsTotalPages;
}

function changeLogsPage(direction) {
    const target = logsCurrentPage + direction;
    gotoLogsPage(target);
}

function gotoLogsPage(page) {
    if (page < 1 || page > logsTotalPages) return;
    logsCurrentPage = page;
    // è¿™é‡Œå¯æ¥å…¥åç«¯åˆ†é¡µAPIè·å–æ•°æ®
    initLogsPagination(logsCurrentPage, logsTotalPages, 1);
}

// ç”¨æˆ·åˆ†é¡µï¼ˆæ¼”ç¤ºç”¨ï¼šä»…UIä¸çŠ¶æ€ï¼‰
let usersCurrentPage = 1;
let usersTotalPages = 1;

function initUsersPagination(current, total, totalCount) {
    usersCurrentPage = current;
    usersTotalPages = Math.max(1, total);
    const info = document.getElementById('users-pagination-info');
    const pagesEl = document.getElementById('users-pagination-pages');
    const prevBtn = document.getElementById('users-prev-btn');
    const nextBtn = document.getElementById('users-next-btn');
    if (info) info.textContent = `ç¬¬ ${usersCurrentPage} / ${usersTotalPages} é¡µï¼Œå…± ${totalCount} æ¡`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= usersTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === usersCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoUsersPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = usersCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = usersCurrentPage >= usersTotalPages;
}

function changeUsersPage(direction) {
    const target = usersCurrentPage + direction;
    gotoUsersPage(target);
}

function gotoUsersPage(page) {
    if (page < 1 || page > usersTotalPages) return;
    usersCurrentPage = page;
    // è¿™é‡Œå¯æ¥å…¥åç«¯åˆ†é¡µAPIè·å–ç”¨æˆ·æ•°æ®
    initUsersPagination(usersCurrentPage, usersTotalPages, 1);
}

// è§’è‰²åˆ†é¡µï¼ˆæ¼”ç¤ºç”¨ï¼šä»…UIä¸çŠ¶æ€ï¼‰
let rolesCurrentPage = 1;
let rolesTotalPages = 1;

function initRolesPagination(current, total, totalCount) {
    rolesCurrentPage = current;
    rolesTotalPages = Math.max(1, total);
    const info = document.getElementById('roles-pagination-info');
    const pagesEl = document.getElementById('roles-pagination-pages');
    const prevBtn = document.getElementById('roles-prev-btn');
    const nextBtn = document.getElementById('roles-next-btn');
    if (info) info.textContent = `ç¬¬ ${rolesCurrentPage} / ${rolesTotalPages} é¡µï¼Œå…± ${totalCount} æ¡`;
    if (pagesEl) {
        pagesEl.innerHTML = '';
        for (let i = 1; i <= rolesTotalPages; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === rolesCurrentPage ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => gotoRolesPage(i);
            pagesEl.appendChild(btn);
        }
    }
    if (prevBtn) prevBtn.disabled = rolesCurrentPage <= 1;
    if (nextBtn) nextBtn.disabled = rolesCurrentPage >= rolesTotalPages;
}

function changeRolesPage(direction) {
    const target = rolesCurrentPage + direction;
    gotoRolesPage(target);
}

function gotoRolesPage(page) {
    if (page < 1 || page > rolesTotalPages) return;
    rolesCurrentPage = page;
    // è¿™é‡Œå¯æ¥å…¥åç«¯åˆ†é¡µAPIè·å–è§’è‰²æ•°æ®
    initRolesPagination(rolesCurrentPage, rolesTotalPages, 1);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
// è½½å…¥ä¸æ¸²æŸ“
// è¿™äº›å‡½æ•°å·²ç§»è‡³ main.js ä¸­ï¼Œé¿å…å‡½æ•°åå†²çª

// è¿™äº›å‡½æ•°å·²ç§»è‡³ main.js ä¸­ï¼Œé¿å…å‡½æ•°åå†²çª

function populateRoleOptions(selectId) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const roles = window.__rolesCache || [];
    sel.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²</option>' + roles.map(r => `<option value="${r.id}">${r.role_name}</option>`).join('');
}

// submitNewUser å‡½æ•°å·²ç§»è‡³ main.js ä¸­

// æ•°æ®åŠ è½½é€»è¾‘å·²ç§»è‡³ main.js ä¸­çš„ initializeSystemManagementPage å‡½æ•°

// è§’è‰²æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½è§’è‰²åˆ—è¡¨
    loadRolesList();
});

// å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
window.showRoleForm = showRoleForm;
window.closeRoleModal = closeRoleModal;
window.saveRole = saveRole;
window.editRole = editRole;
window.deleteRole = deleteRole;
window.loadRolesList = loadRolesList;
window.renderRolesTable = renderRolesTable;
</script>
